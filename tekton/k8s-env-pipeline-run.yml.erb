apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  generateName: env-<%= ENV['PERSON'] %>-<%= ENV['ACTION'] %>-
  namespace: devops
spec:
  serviceAccountName: tekton-sa
  pipelineRef:
    name: cloud-dev-env-pipeline
  params:
    <% unless ENV['INFRA_REPO_REVISION'].nil? || ENV['INFRA_REPO_REVISION'] == "" %>
    - name: cloudDevRepoRevision
      value: <%= ENV['INFRA_REPO_REVISION'] %>
    <% end %>
    - name: personName
      value: <%= ENV['PERSON'] %>
    - name: action
      value: <%= ENV['ACTION'] %>
    <% unless ENV['STORAGE_SIZE'].nil?  || ENV['STORAGE_SIZE'] == "" %>
    - name: storageSize
      value: <%= ENV['STORAGE_SIZE'] %>
    <% end %>
    <% unless ENV['PUBLIC_KEY_URL'].nil? || ENV['PUBLIC_KEY_URL'] == "" %>
    - name: personPublicKeyUrl
      value: <%= ENV['PUBLIC_KEY_URL'] %>
    <% end %>
    <% unless ENV['IDE_IMAGE_TAG'].nil? || ENV['IDE_IMAGE_TAG'] == "" %>
    - name: ideContainerImage
      value: 260741046218.dkr.ecr.us-east-1.amazonaws.com/cloud-dev:<%= ENV['IDE_IMAGE_TAG'] %>
    <% end %>
  workspaces:
    - name: git-source
      volumeClaimTemplate:
        spec:
          storageClassName: gp3-tekton-pipeline
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 1Gi
